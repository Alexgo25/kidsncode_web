var nodes=function(){return{body:$(document.body),platform:$(".js-platform"),robot:$(".js-robot"),award:$(".js-award"),win:$(".js-window"),program:$(".js-program"),controls:$(".js-controls"),loop:$(".js-loop")}}(),properties=function(){var o={1:{cubes:{x:[0,1,2,3,4,5,6,7,8,9,10,11,0,1,2,3,4,5,6,7,8,9,10,11,0,1,2,5,6,7,9,0,6,7,9,7],y:[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,3,3,4]},robot:{x:2,y:3,direction:"right"},award:{x:[9,11],y:[4,2],url:["http://cs631829.vk.me/v631829533/2cb3/V3icNf7q5fs.jpg","http://cs624818.vk.me/v624818533/31842/RUu8UoenACM.jpg"]}}};return o[1]}(),helpers=function(o){return{getCubesCordinates:function(){for(var t=o.win.find(".js-platform-cube"),e={x:[],y:[]},n=0;n<t.length;n++)e.x.push(Math.abs(parseInt(t.eq(n).css("left"))/100)),e.y.push(Math.abs((parseInt(t.eq(n).css("top"))+100)/-100));return e},getRobotCordinates:function(){var t={},e=parseInt(o.robot.css("left")),n=parseInt(o.robot.css("top"));return t.x=(e-20)/100,t.y=(n+133)/-100,t},getCubeNode:function(t,e){for(var n=100*t+"px",r=-100*e-100+"px",s=o.platform.find(".js-platform-cube"),a=0;a<s.length;a++)if(s.eq(a).css("left")===n&&s.eq(a).css("top")===r)return s.eq(a)},getAwardNode:function(t,e){for(var n=40+100*t+"px",r=-100*e-100+"px",s=o.platform.find(".js-award"),a=0;a<s.length;a++)if(s.eq(a).css("left")===n&&s.eq(a).css("top")===r)return s.eq(a)},setZindexes:function(t){for(var e,n,r=0,s=helpers.getRobotCordinates(),a=helpers.getCubesCordinates(),i="horizontal"===t?100*s.y+s.x:100*s.x+s.y;r<a.y.length;r++)n="horizontal"===t?100*a.y[r]+a.x[r]:100*a.x[r]+a.y[r],e=helpers.getCubeNode(a.x[r],a.y[r]),e.css("zIndex",n);o.robot.find(".js-robot-model").css("zIndex",i)},setFutureZ:function(t){var e=100*((t.top+133)/-100)+(t.left-20)/100;o.robot.find(".js-robot-model").css("zIndex",e)}}}(nodes),animations=function(o){return{awardTop:function(){$(".js-award").animate({marginTop:"-=50"},1500).promise().done(function(){animations.awardBottom()})},awardBottom:function(){$(".js-award").animate({marginTop:"+=50"},1500).promise().done(function(){animations.awardTop()})},robotWalk:function(t){!function e(n,r){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-walk-'+t+"-"+n+'"></span>'),9>n&&(2===r||1===r)?(n++,e(n,r)):2===r&&e(1,1)},50)}(1,2)},robotReverse:function(t){"left"===t?!function e(t){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-turn-'+t+'"></span>'),7>t&&(t++,e(t))},101)}(1):"right"===t&&!function n(t){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-turn-'+t+'"></span>'),t>1&&(t--,n(t))},101)}(7)},robotPush:function(t){var e=function(t,n){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-push-'+n+"-"+t+'"></span>'),t>1&&(t--,e(t,n))},50)};!function n(t,r){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-push-'+r+"-"+t+'"></span>'),5>t?(t++,n(t,r)):e(5,r)},50)}(1,t)},robotMistake:function(t){var e=function(n){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-mistake-'+n+'"></span>'),9>n?(n++,e(n)):r(5,t)},100)},n=function(t,r){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-turn-facing-'+r+"-"+t+'"></span>'),5>t?(t++,n(t,r)):e(1)},100)},r=function(t,e){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-turn-facing-'+e+"-"+t+'"></span>'),t>1&&(t--,r(t,e))},100)};n(1,t)},robotJump:function(t){var e=function(t,n){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-jump-'+n+"-"+t+'"></span>'),t>1&&(t--,e(t,n))},100)};!function n(t,r){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-jump-'+r+"-"+t+'"></span>'),8>t?(t++,n(t,r)):setTimeout(function(){e(8,r)},300)},100)}(1,t)},robotTurnFacing:function(t){!function e(t,n){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-turn-facing-'+n+"-"+t+'"></span>'),5>t&&(t++,e(t,n))},100)}(1,t)},robotTurnFacingBack:function(t){!function e(t,n){setTimeout(function(){o.robot.find(".js-robot-model").html('<span class="sprite icon-robot-turn-facing-'+n+"-"+t+'"></span>'),t>1&&(t--,e(t,n))},100)}(5,t)}}}(nodes),setup=function(o,t,e,n){return{init:function(){t.platform.find(".js-platform-cube").remove(),t.platform.find(".js-award").remove(),setup.setCubes(),setup.setRobot(),setup.setAward(),o.setZindexes("horizontal"),n.awardTop()},setRobot:function(){t.robot.data("direction",e.robot.direction),t.robot.css({left:20+100*e.robot.x+"px",top:-100*e.robot.y-133+"px"}),t.robot.find(".js-robot-model").html('<span class="sprite icon-robot-'+e.robot.direction+'"></span>')},setCubes:function(){for(var o=e.cubes,n=0;n<o.x.length;n++){var r=100*o.x[n]+"px",s=-100*o.y[n]-100+"px";t.platform.prepend('<div class="window-platform__cube js-platform-cube"style="left: '+r+"; top: "+s+'"><span class="sprite icon-cube"></span></div>')}},setAward:function(){for(var o=0;o<e.award.x.length;o++){var n=40+100*e.award.x[o]+"px",r=-100*e.award.y[o]-100+"px";t.platform.append('<div class="window-award js-award"style="left: '+n+"; top: "+r+"; background-image: url("+e.award.url[o]+');"></div>')}}}}(helpers,nodes,properties,animations);setup.init();var actions=function(o,t,e,n,r){var s={actionIndex:0,programStarted:!1,awardsFinded:0},a={setEvents:function(){t.controls.on({click:function(){var o=t.program.find(".js-program-actions").children();o.length>0&&(s.programStarted=!0,a.setAction(),t.robot.removeClass("is-select"))}},".js-controls-start"),t.controls.on({click:function(){e.init(),s.actionIndex=0,s.programStarted=!1}},".js-controls-cancel"),t.controls.on({click:function(){var o=t.program.find(".js-program-actions");e.init(),o.html(""),s.actionIndex=0,s.programStarted=!1}},".js-controls-restart"),t.controls.on({click:function(){var o=t.program.find(".js-program-actions").children();o.length>0&&(a.setAction(),t.robot.removeClass("is-select"))}},".js-controls-debug")},setAction:function(){var o=t.program.find(".js-program-actions").children(),e=s.actionIndex;if(o.removeClass("is-selected"),o.eq(e).hasClass("js-program-action")){switch(o.eq(e).data("action")){case"walk":a.robotWalk();break;case"reverse":a.robotReverse();break;case"push":a.robotPush();break;case"jump":a.robotJump()}o.eq(e).addClass("is-selected")}s.actionIndex++},robotWalk:function(){var e="right"===t.robot.data("direction")?"+":"-",n=a.checkWalk(e+1);return"jump"===n.special?void a.robotJump():void(0===n.errors?(r.robotWalk(t.robot.data("direction")),t.robot.animate({left:e+"=100px"},1e3,function(){o.setZindexes("horizontal"),a.checkAward(),s.programStarted&&a.setAction()})):(r.robotMistake(t.robot.data("direction")),setTimeout(function(){a.checkAward(),s.programStarted&&a.setAction()},2e3)))},robotReverse:function(){var o=t.robot.data("direction");"right"===o?(r.robotReverse("left"),t.robot.data("direction","left")):(r.robotReverse("right"),t.robot.data("direction","right")),setTimeout(function(){s.programStarted&&a.setAction()},1e3)},robotPush:function(){var e,n="right"===t.robot.data("direction")?"+":"-",i=a.checkPush(n+1);i.exist&&i.pushable?(r.robotPush(t.robot.data("direction")),i.direction=n,e=o.getCubeNode(i.x,i.y),i.fallable?e.animate({left:n+"=100px"},1e3,function(){o.setZindexes("vertical"),e.animate({top:"+="+100*i.fallRange+"px"},250,function(){o.setZindexes("horizontal"),a.checkAward(),s.programStarted&&a.setAction()})}):e.animate({left:n+"=100px"},1e3,function(){o.setZindexes("horizontal"),a.checkAward(),s.programStarted&&a.setAction()})):(r.robotMistake(t.robot.data("direction")),setTimeout(function(){a.checkAward(),s.programStarted&&a.setAction()},2e3))},robotJump:function(){var e,n="right"===t.robot.data("direction")?"+":"-",i=a.checkJump(n+1);i.possibility?(e={start:{x:i.start.left,y:i.start.top,angle:i.start.angle},end:{x:i.end.left,y:i.end.top-1,angle:i.end.angle,length:i.end.length}},r.robotJump(t.robot.data("direction")),setTimeout(function(){setTimeout(function(){o.setFutureZ(i.end)},600),t.robot.animate({path:new $.path.bezier(e)},1e3,function(){o.setZindexes("horizontal"),setTimeout(function(){a.checkAward(),s.programStarted&&a.setAction()},400)})},400)):(r.robotMistake(t.robot.data("direction")),setTimeout(function(){a.checkAward(),s.programStarted&&a.setAction()},2e3))},checkWalk:function(t){for(var e=o.getRobotCordinates(),n=o.getCubesCordinates(),r={errors:0,special:null},s=0;s<n.x.length;s++)e.x+parseInt(t)===n.x[s]&&e.y===n.y[s]&&r.errors++;return void 0===o.getCubeNode(e.x+parseInt(t),e.y-1)&&(r.special="jump"),r},checkPush:function(t){for(var e=o.getRobotCordinates(),n=o.getCubesCordinates(),r={exist:!1,pushable:!0,fallable:!0,x:null,y:null},s=0;s<n.x.length;s++)e.x+parseInt(t)===n.x[s]&&e.y===n.y[s]&&(r.exist=!0,r.x=n.x[s],r.y=n.y[s]);for(var a=0;a<n.x.length;a++)n.x[a]===r.x+1&&n.y[a]===r.y?r.pushable=!1:n.x[a]===r.x&&n.y[a]===r.y+1?r.pushable=!1:n.x[a]===r.x+1&&n.y[a]===r.y-1&&(r.fallable=!1);if(r.fallable){for(var i=0,l=0;l<n.x.length;l++)n.x[l]===r.x+1&&n.y[l]<r.y&&i++;r.fallRange=r.y-i}return r.node=o.getCubeNode(r.x,r.y),r},checkJump:function(e){for(var n=o.getRobotCordinates(),r=o.getCubesCordinates(),s={possibility:!0,trajectory:"straight",start:{},end:{}},a=0;a<r.x.length;a++)n.x+parseInt(e)===r.x[a]&&n.y===r.y[a]-1?s.possibility=!1:n.x+parseInt(e)===r.x[a]&&n.y===r.y[a]&&(s.trajectory="to-top");return void 0===o.getCubeNode(n.x+parseInt(e),n.y-2)&&n.y>2&&(s.possibility=!1),void 0===o.getCubeNode(n.x+parseInt(e),n.y-1)&&(s.trajectory="to-bottom",1===n.y&&(s.possibility=!1)),s.start.left=parseInt(t.robot.css("left")),s.start.top=parseInt(t.robot.css("top")),s.end.left=parseInt(t.robot.css("left"))+100*parseInt(e),s.start.angle=-50*parseInt(e),s.end.angle=100*parseInt(e),s.end.length=1,"to-top"===s.trajectory?s.end.top=parseInt(t.robot.css("top"))-100:"to-bottom"===s.trajectory?(s.end.top=parseInt(t.robot.css("top"))+100,s.start.angle=120*parseInt(e),s.end.angle=50*parseInt(e),s.end.length=2.2):s.end.top=parseInt(t.robot.css("top")),s},checkAward:function(){for(var t,e=o.getRobotCordinates(),r=0;r<n.award.x.length;r++)n.award.x[r]===e.x&&n.award.y[r]===e.y&&(t=o.getAwardNode(n.award.x[r],n.award.y[r]),t.remove(),s.awardsFinded++)}};a.setEvents()}(helpers,nodes,setup,properties,animations),loopSlider=function(){var o,t,e,n,r,s=$(".js-loop-slider"),a=s.find(".js-loop-slider-left"),i=s.find(".js-loop-slider-right"),l=s.find(".js-loop-slider-elements"),c=$(document.body),d=!0;c.on({click:function(){if("right-false"!==r()&&d){d=!1,o=s.find(".js-loop-slider-element");for(var a=0;a<o.length;a++)o.eq(a).hasClass("is-active")?(t=o.eq(a),e=t.data("index"),n='<div class="panel-controls__loop-element js-loop-slider-element is-active" data-index="'+(e+1)+'">'+(e+1)+"</div>",t.css("marginLeft","-100%").removeClass("is-active").addClass("is-left"),l.append(n)):(o.eq(a).hasClass("is-left")||o.eq(a).hasClass("is-right"))&&o.eq(a).remove();r()}}},".js-loop-slider-right"),c.on({click:function(){if("left-false"!==r()&&d){d=!1,o=s.find(".js-loop-slider-element");for(var a=0;a<o.length;a++)o.eq(a).hasClass("is-active")?(t=o.eq(a),e=t.data("index"),n='<div class="panel-controls__loop-element js-loop-slider-element is-active is-margin-left" data-index="'+(e-1)+'">'+(e-1)+"</div>",l.prepend(n),t.removeClass("is-active").addClass("is-right"),setTimeout(function(){s.find(".is-margin-left").removeClass("is-margin-left")},2)):(o.eq(a).hasClass("is-left")||o.eq(a).hasClass("is-right"))&&o.eq(a).remove();r()}}},".js-loop-slider-left"),c.on({transitionend:function(){d=!0}},".js-loop-slider-element"),(r=function(){o=s.find(".js-loop-slider-element");for(var t=0;t<o.length;t++)if(o.eq(t).hasClass("is-active")){if(1===o.eq(t).data("index"))return a.addClass("is-disabled"),"left-false";if(20===o.eq(t).data("index"))return i.addClass("is-disabled"),"right-false"}else a.removeClass("is-disabled"),i.removeClass("is-disabled")})()}(),program=function(o,t,e){var n={setEvents:function(){t.robot.on({click:function(){$(this).toggleClass("is-select"),$(this).hasClass("is-select")?e.robotTurnFacing(t.robot.data("direction")):e.robotTurnFacingBack(t.robot.data("direction"))}}),t.robot.on({click:function(o){o.preventDefault(),o.stopPropagation();var e=$(this).data("action"),r=n.getActionName(e),s='<div class="panel-program__action js-program-action" data-action="'+e+'">'+r+"</div>";t.program.find(".js-program-actions").append(s)}},".js-robot-action"),t.program.on({click:function(){$(this).parents(".js-program-loop").length||($(this).toggleClass("is-loopy"),n.openLoopControl())}},".js-program-action"),t.loop.on({click:function(){var o,e=t.program.find(".js-program-action.is-loopy"),n=e.first(),r=t.controls.find(".js-loop-slider-element.is-active").data("index");n.before('<div class="panel-program__loop js-program-loop is-new" data-index="'+r+'"><div class="panel-program__loop-angle js-program-loop-angle"><div class="panel-program__loop-horizontal"></div><div class="panel-program__loop-vertical js-program-loop-angle-vertical"></div><div class="panel-program__loop-title js-program-loop-angle-title"></div></div></div>'),o=t.program.find(".js-program-loop.is-new"),o.append(e.removeClass("is-loopy")),t.controls.removeClass("is-loop"),setTimeout(function(){o.find(".js-program-loop-angle-title").append("ПОВТОРИТЬ x"+r),o.find(".js-program-loop-angle").addClass("is-open"),o.find(".js-program-loop-angle-vertical").css("min-height",48+40*e.length+"px"),o.removeClass("is-new")},500)}},".js-loop-submit"),t.loop.on({click:function(){variables.newLoop=[],t.controls.removeClass("is-loop")}},".js-loop-cancel")},openLoopControl:function(){var o=t.program.find(".js-program-action.is-loopy");o.length>0?t.controls.addClass("is-loop"):t.controls.removeClass("is-loop")},getActionName:function(o){switch(o){case"walk":return"шагнуть";case"reverse":return"повернуть";case"push":return"толкнуть";case"jump":return"прыгнуть"}}};n.setEvents()}(helpers,nodes,animations);